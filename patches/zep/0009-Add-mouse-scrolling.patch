From 253e4ac087de7cf5fa4404d1a9e7fb9029c9a05c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jozef=20=C4=8C=C3=AD=C5=BE?= <jozef.ciz.ml@gmail.com>
Date: Thu, 14 Apr 2022 10:52:55 +0200
Subject: [PATCH] Add mouse scrolling

Add mouse scrolling in all modes without moving cursor.
---
 include/zep/editor.h             | 9 +++++++++
 include/zep/imgui/editor_imgui.h | 9 +++++++++
 src/editor.cpp                   | 8 ++++++++
 src/window.cpp                   | 7 ++++++-
 4 files changed, 32 insertions(+), 1 deletion(-)

diff --git a/include/zep/editor.h b/include/zep/editor.h
index dc4030a9..3fba597b 100644
--- a/include/zep/editor.h
+++ b/include/zep/editor.h
@@ -89,6 +89,7 @@ enum class Msg
     MouseMove,
     MouseDown,
     MouseUp,
+    MouseWheel,
     Buffer,
     ComponentChanged,
     Tick,
@@ -112,6 +113,13 @@ public:
         , button(b)
     {
     }
+    
+    ZepMessage(Msg id, const NVec2f& p, std::string strIn)
+        : messageId(id)
+        , pos(p)
+        , str(strIn)
+    {
+    }
 
     ZepMessage(Msg id, IZepComponent* pComp)
         : messageId(id)
@@ -375,6 +383,7 @@ public:
     bool OnMouseMove(const NVec2f& mousePos);
     bool OnMouseDown(const NVec2f& mousePos, ZepMouseButton button);
     bool OnMouseUp(const NVec2f& mousePos, ZepMouseButton button);
+    bool OnMouseWheel(const NVec2f& mousePos, float scrollDistance);
     const NVec2f GetMousePos() const;
 
     void SetBufferSyntax(ZepBuffer& buffer) const;
diff --git a/include/zep/imgui/editor_imgui.h b/include/zep/imgui/editor_imgui.h
index 326e43c6..5eea29fd 100644
--- a/include/zep/imgui/editor_imgui.h
+++ b/include/zep/imgui/editor_imgui.h
@@ -117,6 +117,15 @@ public:
                 io.MouseClicked[0] = false;
             }
         }
+        if (io.MouseWheel)
+        {
+            if (OnMouseWheel(toNVec2f(io.MousePos), io.MouseWheel))
+            {
+                // Hide the mouse scroll from imgui if we handled it
+                io.MouseWheel = 0;
+            }
+        }
+
 
         if (io.KeyCtrl)
         {
diff --git a/src/editor.cpp b/src/editor.cpp
index 21300f22..ff446a98 100644
--- a/src/editor.cpp
+++ b/src/editor.cpp
@@ -1317,6 +1317,14 @@ bool ZepEditor::OnMouseUp(const NVec2f& mousePos, ZepMouseButton button)
     return handled;
 }
 
+bool ZepEditor::OnMouseWheel(const NVec2f& mousePos, float scrollDistance)
+{
+    m_mousePos = mousePos;
+    bool handled = Broadcast(std::make_shared<ZepMessage>(Msg::MouseWheel, mousePos, std::to_string(scrollDistance)));
+    m_bPendingRefresh = true;
+    return handled;
+}
+
 const NVec2f ZepEditor::GetMousePos() const
 {
     return m_mousePos;
diff --git a/src/window.cpp b/src/window.cpp
index 71b259c2..23a2c6f4 100644
--- a/src/window.cpp
+++ b/src/window.cpp
@@ -205,7 +205,6 @@ void ZepWindow::Notify(std::shared_ptr<ZepMessage> payload)
             auto pScroller = dynamic_cast<Scroller*>(payload->pComponent);
             m_textOffsetPx = pScroller->vScrollPosition * m_textSizePx.y;
             UpdateVisibleLineRange();
-            EnsureCursorVisible();
             DisableToolTipTillMove();
         }
     }
@@ -240,6 +239,12 @@ void ZepWindow::Notify(std::shared_ptr<ZepMessage> payload)
             SetBufferCursor(m_mouseIterator);
         }
     }
+    else if (payload->messageId == Msg::MouseWheel)
+    {
+        m_textOffsetPx = std::min(m_textSizePx.y, std::max(0.0f, m_textOffsetPx - 5 * stof(payload->str) * GetEditor().GetDisplay().GetFont(ZepTextType::Text).GetPixelHeight()));
+        UpdateVisibleLineRange();
+        DisableToolTipTillMove();
+    }
 }
 
 void ZepWindow::SetDisplayRegion(const NRectf& region)
-- 
2.39.1

