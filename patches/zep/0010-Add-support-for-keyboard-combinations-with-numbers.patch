From 8dd3aa1b3cf01a90732bb4156955a28ae0cf9dac Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jozef=20=C4=8C=C3=AD=C5=BE?= <jozef.ciz.ml@gmail.com>
Date: Tue, 12 Apr 2022 22:34:57 +0200
Subject: [PATCH] Add support for keyboard combinations with numbers

Previously, only keyboard combinations ctrl+1 and ctrl+2 were handled
separately to switch between modes. Now all keyboard combinations
involving numbers can be bound.
---
 include/zep/imgui/editor_imgui.h | 312 +++++++++++++++----------------
 src/mode.cpp                     |  14 +-
 2 files changed, 155 insertions(+), 171 deletions(-)

diff --git a/include/zep/imgui/editor_imgui.h b/include/zep/imgui/editor_imgui.h
index 5eea29fd..d2346932 100644
--- a/include/zep/imgui/editor_imgui.h
+++ b/include/zep/imgui/editor_imgui.h
@@ -2,6 +2,7 @@
 #include <string>
 
 #include "zep/imgui/display_imgui.h"
+#include "zep/imgui/usb_hid_keys.h"
 
 #include "zep/editor.h"
 #include "zep/mode_standard.h"
@@ -13,37 +14,6 @@
 namespace Zep
 {
 
-// These key defines from usb_hid_keys.h; standard USB keycodes.
-// Defined here to stop collisions.
-
-#define ZEP_KEY_F1 0x3a // Keyboard F1
-#define ZEP_KEY_F2 0x3b // Keyboard F2
-#define ZEP_KEY_F3 0x3c // Keyboard F3
-#define ZEP_KEY_F4 0x3d // Keyboard F4
-#define ZEP_KEY_F5 0x3e // Keyboard F5
-#define ZEP_KEY_F6 0x3f // Keyboard F6
-#define ZEP_KEY_F7 0x40 // Keyboard F7
-#define ZEP_KEY_F8 0x41 // Keyboard F8
-#define ZEP_KEY_F9 0x42 // Keyboard F9
-#define ZEP_KEY_F10 0x43 // Keyboard F10
-#define ZEP_KEY_F11 0x44 // Keyboard F11
-#define ZEP_KEY_F12 0x45 // Keyboard F12
-
-#define ZEP_KEY_1 0x1e // Keyboard 1 and !
-#define ZEP_KEY_2 0x1f // Keyboard 2 and @
-#define ZEP_KEY_3 0x20 // Keyboard 3 and #
-#define ZEP_KEY_4 0x21 // Keyboard 4 and $
-#define ZEP_KEY_5 0x22 // Keyboard 5 and %
-#define ZEP_KEY_6 0x23 // Keyboard 6 and ^
-#define ZEP_KEY_7 0x24 // Keyboard 7 and &
-#define ZEP_KEY_8 0x25 // Keyboard 8 and *
-#define ZEP_KEY_9 0x26 // Keyboard 9 and (
-#define ZEP_KEY_0 0x27 // Keyboard 0 and )
-
-#define ZEP_KEY_A 0x04 // Keyboard a and A
-#define ZEP_KEY_Z 0x1d // Keyboard z and Z
-#define ZEP_KEY_SPACE 0x2c // Keyboard Spacebar
-
 class ZepDisplay_ImGui;
 class ZepTabWindow;
 class ZepEditor_ImGui : public ZepEditor
@@ -64,18 +34,18 @@ public:
 
         static std::map<int, int> MapUSBKeys =
         {
-            { ZEP_KEY_F1, ExtKeys::F1},
-            { ZEP_KEY_F2, ExtKeys::F2},
-            { ZEP_KEY_F3, ExtKeys::F3},
-            { ZEP_KEY_F4, ExtKeys::F4},
-            { ZEP_KEY_F5, ExtKeys::F5},
-            { ZEP_KEY_F6, ExtKeys::F6},
-            { ZEP_KEY_F7, ExtKeys::F7},
-            { ZEP_KEY_F8, ExtKeys::F8},
-            { ZEP_KEY_F9, ExtKeys::F9},
-            { ZEP_KEY_F10, ExtKeys::F10},
-            { ZEP_KEY_F11, ExtKeys::F11},
-            { ZEP_KEY_F12, ExtKeys::F12}
+            { KEY_F1, ExtKeys::F1},
+            { KEY_F2, ExtKeys::F2},
+            { KEY_F3, ExtKeys::F3},
+            { KEY_F4, ExtKeys::F4},
+            { KEY_F5, ExtKeys::F5},
+            { KEY_F6, ExtKeys::F6},
+            { KEY_F7, ExtKeys::F7},
+            { KEY_F8, ExtKeys::F8},
+            { KEY_F9, ExtKeys::F9},
+            { KEY_F10, ExtKeys::F10},
+            { KEY_F11, ExtKeys::F11},
+            { KEY_F12, ExtKeys::F12}
         };
         if (io.MouseDelta.x != 0 || io.MouseDelta.y != 0)
         {
@@ -137,158 +107,172 @@ public:
         }
 
         auto pBuffer = GetActiveBuffer();
+        if (!pBuffer) return;
 
-        if (pBuffer)
+        // Check USB Keys
+        for (auto& usbKey : MapUSBKeys)
         {
-            // Check USB Keys
-            for (auto& usbKey : MapUSBKeys)
-            {
-                if (ImGui::IsKeyPressed(ImGuiKey(usbKey.first)))
-                {
-                    pBuffer->GetMode()->AddKeyPress(usbKey.second, mod);
-                    return;
-                }
-            }
-
-            if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Tab)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::TAB, mod);
-                return;
-            }
-            if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Escape)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::ESCAPE, mod);
-                return;
-            }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Enter)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::RETURN, mod);
-                return;
-            }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Delete)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::DEL, mod);
-                return;
-            }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Home)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::HOME, mod);
-                return;
-            }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_End)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::END, mod);
-                return;
-            }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Backspace)))
+            if (ImGui::IsKeyPressed(ImGuiKey(usbKey.first)))
             {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::BACKSPACE, mod);
+                pBuffer->GetMode()->AddKeyPress(usbKey.second, mod);
                 return;
             }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_RightArrow)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::RIGHT, mod);
-                return;
-            }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_LeftArrow)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::LEFT, mod);
-                return;
-            }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_UpArrow)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::UP, mod);
-                return;
-            }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_DownArrow)))
-            {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::DOWN, mod);
-                return;
-            }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_PageDown)))
+        }
+
+        if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Tab)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::TAB, mod);
+            return;
+        }
+        if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Escape)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::ESCAPE, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Enter)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::RETURN, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Delete)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::DEL, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Home)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::HOME, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_End)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::END, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_Backspace)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::BACKSPACE, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_RightArrow)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::RIGHT, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_LeftArrow)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::LEFT, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_UpArrow)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::UP, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_DownArrow)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::DOWN, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_PageDown)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::PAGEDOWN, mod);
+            return;
+        }
+        else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_PageUp)))
+        {
+            pBuffer->GetMode()->AddKeyPress(ExtKeys::PAGEUP, mod);
+            return;
+        }
+        else if (io.KeyCtrl)
+        {
+            // SDL Remaps to its own scancodes; and since we can't look them up in the standard IMGui list
+            // without modifying the ImGui base code, we have special handling here for CTRL.
+            // For the Win32 case, we use VK_A (ASCII) is handled below
+#if defined(_SDL_H) || defined(ZEP_USE_SDL)
+            if (ImGui::IsKeyPressed(ImGuiKey(KEY_1)))
             {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::PAGEDOWN, mod);
-                return;
+                SetGlobalMode(ZepMode_Standard::StaticName());
+                handled = true;
             }
-            else if (ImGui::IsKeyPressed(ImGui::GetKeyIndex(ImGuiKey_PageUp)))
+            else if (ImGui::IsKeyPressed(ImGuiKey(KEY_2)))
             {
-                pBuffer->GetMode()->AddKeyPress(ExtKeys::PAGEUP, mod);
-                return;
+                SetGlobalMode(ZepMode_Vim::StaticName());
+                handled = true;
             }
-            else if (io.KeyCtrl)
+            else
             {
-                // SDL Remaps to its own scancodes; and since we can't look them up in the standard IMGui list
-                // without modifying the ImGui base code, we have special handling here for CTRL.
-                // For the Win32 case, we use VK_A (ASCII) is handled below
-#if defined(_SDL_H) || defined(ZEP_USE_SDL)
-                if (ImGui::IsKeyPressed(ImGuiKey(ZEP_KEY_1)))
-                {
-                    SetGlobalMode(ZepMode_Standard::StaticName());
-                    handled = true;
-                }
-                else if (ImGui::IsKeyPressed(ImGuiKey(ZEP_KEY_2)))
+                for (int ch = KEY_1; ch <= KEY_0; ch++)
                 {
-                    SetGlobalMode(ZepMode_Vim::StaticName());
-                    handled = true;
-                }
-                else
-                {
-                    for (int ch = ZEP_KEY_A; ch <= ZEP_KEY_Z; ch++)
-                    {
-                        if (ImGui::IsKeyPressed(ImGuiKey(ch)))
-                        {
-                            pBuffer->GetMode()->AddKeyPress((ch - ZEP_KEY_A) + 'a', mod);
-                            handled = true;
-                        }
-                    }
-
-                    if (ImGui::IsKeyPressed(ImGuiKey(ZEP_KEY_SPACE)))
+                    if (ImGui::IsKeyPressed(ImGuiKey(ch)))
                     {
-                        pBuffer->GetMode()->AddKeyPress(' ', mod);
+                        pBuffer->GetMode()->AddKeyPress(ch == KEY_0 ? '0' : ch - KEY_1 + '1', mod);
                         handled = true;
                     }
                 }
-#else
-                if (ImGui::IsKeyPressed(ImGuiKey('1')))
+                for (int ch = KEY_A; ch <= KEY_Z; ch++)
                 {
-                    SetGlobalMode(ZepMode_Standard::StaticName());
-                    handled = true;
+                    if (ImGui::IsKeyPressed(ImGuiKey(ch)))
+                    {
+                        pBuffer->GetMode()->AddKeyPress((ch - KEY_A) + 'a', mod);
+                        handled = true;
+                    }
                 }
-                else if (ImGui::IsKeyPressed(ImGuiKey('2')))
+
+                if (ImGui::IsKeyPressed(ImGuiKey(KEY_SPACE)))
                 {
-                    SetGlobalMode(ZepMode_Vim::StaticName());
+                    pBuffer->GetMode()->AddKeyPress(' ', mod);
                     handled = true;
                 }
-                else
+            }
+#else
+            if (ImGui::IsKeyPressed(ImGuiKey('1')))
+            {
+                SetGlobalMode(ZepMode_Standard::StaticName());
+                handled = true;
+            }
+            else if (ImGui::IsKeyPressed(ImGuiKey('2')))
+            {
+                SetGlobalMode(ZepMode_Vim::StaticName());
+                handled = true;
+            }
+            else
+            {
+                for (int ch = '0'; ch <= '9'; ch++)
                 {
-                    for (int ch = 'A'; ch <= 'Z'; ch++)
+                    if (ImGui::IsKeyPressed(ImGuiKey(ch)))
                     {
-                        if (ImGui::IsKeyPressed(ImGuiKey(ch)))
-                        {
-                            pBuffer->GetMode()->AddKeyPress(ch - 'A' + 'a', mod);
-                            handled = true;
-                        }
+                        pBuffer->GetMode()->AddKeyPress(ch, mod);
+                        handled = true;
                     }
-
-                    if (ImGui::IsKeyPressed(ImGuiKey(ZEP_KEY_SPACE)))
+                }
+                for (int ch = 'A'; ch <= 'Z'; ch++)
+                {
+                    if (ImGui::IsKeyPressed(ImGuiKey(ch)))
                     {
-                        pBuffer->GetMode()->AddKeyPress(' ', mod);
+                        pBuffer->GetMode()->AddKeyPress(ch - 'A' + 'a', mod);
                         handled = true;
                     }
                 }
-#endif
+
+                if (ImGui::IsKeyPressed(ImGuiKey(KEY_SPACE)))
+                {
+                    pBuffer->GetMode()->AddKeyPress(' ', mod);
+                    handled = true;
+                }
             }
+#endif
+        }
 
-            if (!handled)
+        if (!handled)
+        {
+            for (int n = 0; n < io.InputQueueCharacters.Size && io.InputQueueCharacters[n]; n++)
             {
-                for (int n = 0; n < io.InputQueueCharacters.Size && io.InputQueueCharacters[n]; n++)
-                {
-                    // Ignore '\r' - sometimes ImGui generates it!
-                    if (io.InputQueueCharacters[n] == '\r')
-                        continue;
+                // Ignore '\r' - sometimes ImGui generates it!
+                if (io.InputQueueCharacters[n] == '\r')
+                    continue;
 
-                    pBuffer->GetMode()->AddKeyPress(io.InputQueueCharacters[n], mod);
-                }
+                pBuffer->GetMode()->AddKeyPress(io.InputQueueCharacters[n], mod);
             }
         }
     }
diff --git a/src/mode.cpp b/src/mode.cpp
index df3af365..c862cfe1 100644
--- a/src/mode.cpp
+++ b/src/mode.cpp
@@ -288,13 +288,13 @@ std::string ZepMode::ConvertInputToMapString(uint32_t key, uint32_t modifierKeys
         str << "<C-";
         if (modifierKeys & ModifierKey::Shift)
         {
-            // Add the S- modifier for shift enabled special keys
-            // We want to avoid adding S- to capitalized (and already shifted)
-            // keys
-            if (key < ' ')
-            {
+            // // Add the S- modifier for shift enabled special keys
+            // // We want to avoid adding S- to capitalized (and already shifted)
+            // // keys
+            // if (key < ' ')
+            // {
                 str << "S-";
-            }
+            // }
         }
         closeBracket = true;
     }
@@ -377,7 +377,7 @@ void ZepMode::AddKeyPress(uint32_t key, uint32_t modifierKeys)
     key &= 0xFF;
 
     // Keys in this range converted to UTF8.  I need to figure out how to generically receive UTF8 here, but this
-    // temporary fix enables £-sign and other specials to display and work correctly
+    // temporary fix enables Â£-sign and other specials to display and work correctly
     if (key >= 127 && key <= 255)
     {
 
-- 
2.39.1

